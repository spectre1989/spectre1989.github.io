<!DOCTYPE html>
<html lang="en-gb">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.121.2">

    

    

    
        
            <meta
                name="description"
                content="Adventures in netcode, game engines, and game development" />
        

        
            <meta
                name="keywords"
                content="netcode,programming,gamedev,c&#43;&#43;,unreal,UE5,unity,games,sockets" />
        

        
            <meta
                name="author"
                content="Joe Best-Rotheray" />
        

    


    <title>
        
            Making a Multiplayer FPS in C&#43;&#43; Part 8: Client-Side Prediction Revisited |
            
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    
        
            
            
        
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_b09f3b5.min.981b5487040e8fce2ff189ee791909f986edaaa96533f9897e9d4d1098f144164fedf5c696cd286fd09c8ad2d28103cfb60098771aa1d69f6a896abe6a57329c.css"
            integrity="sha512-mBtUhwQOj84v8YnueRkJ&#43;YbtqqllM/mJfp1NEJjxRBZP7fXGls0ob9CcitLSgQPPtgCYdxqh1p9qiWq&#43;alcynA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Making a Multiplayer FPS in C&#43;&#43; Part 8: Client-Side Prediction Revisited -
            
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Making a Multiplayer FPS in C&#43;&#43; </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part8/" title="./multiplayer-fps/part8/">
                         Part 8: Client-Side Prediction Revisited 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part7/" title="./multiplayer-fps/part7/">
                         Part 7: The Vulkan Projection Matrix 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part6/" title="./multiplayer-fps/part6/">
                         Part 6: Cleanup 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part5/" title="./multiplayer-fps/part5/">
                         Part 5: Client-Side Prediction 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part4/" title="./multiplayer-fps/part4/">
                         Part 4: Rebuilding The Client in C&#43;&#43; 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part3/" title="./multiplayer-fps/part3/">
                         Part 3: Multiple Players 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part2/" title="./multiplayer-fps/part2/">
                         Part 2: The Main Loop 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part1/" title="./multiplayer-fps/part1/">
                         Part 1: Hello Multiplayer World 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/unity-client-side-prediction/" title="./posts/unity-client-side-prediction/">
                         Client-Side Prediction With Physics In Unity 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/ditching-the-mutex/" title="./posts/ditching-the-mutex/">
                         Ditching the Mutex 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>


        
            <div class="headerLogo">
                <a href="https://codersblock.org/"><img src="https://codersblock.org/images/logo.png"/></a>
            </div>
        
        <div class="title">
            <h1 class="title-header">
                Making a Multiplayer FPS in C&#43;&#43; Part 8: Client-Side Prediction Revisited
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/joe-best-rotheray/"
                                class="cat-btn">
                                Joe Best-Rotheray
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2019.06.07"
                            >2019.06.07
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        9 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="https://codersblock.org/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/" class="bread-btn">
    

    
        Making a Multiplayer FPS in C&#43;&#43;
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/part8/" class="bread-btn">
    

    
        Part 8: Client-Side Prediction Revisited
    
</a>

                </div>
            

            
        </div>

        
            

        


        <div class="content">
            
                <p>I was lucky enough to go to GDC 2018, and while there I had the pleasure of sitting down with Glenn Fiedler in a really rather swanky tea place. For those not already aware, Glenn is pretty much &ldquo;the netcode guy&rdquo;. If you’re looking on the web for information about netcode and network models, then you’ll almost certainly read <a href="https://gafferongames.com/">some of his articles</a>. They contain a lot more detail than most about the actual implementation of the ideas, you can watch all the GDC videos about networking that you like, at some point it’s great to see some actual code. Even the <a href="https://developer.valvesoftware.com/wiki/Latency_Compensating_Methods_in_Client/Server_In-game_Protocol_Design_and_Optimization">Barnier paper from 2001</a> was pretty high level really - you could download the Source Engine source code, but it’ll take a while to get a foothold in a new large codebase. In 2009 when I was in my first job in the industry as a lowly intern, I was tasked with making an MMO client. I’d never even opened a socket at that point, in my googling I found Glenn’s site, I soon got pretty obsessed with netcode, and the rest is history.</p>
<p>The reason for meeting Glenn was to find out about his new company <a href="https://networknext.com/">Network Next</a> - which is also well worth checking out, the implications for multiplayer games are huge. The conversation turned to netcode, and he rapidly ran through various snapshot-interpolation related things that he thought I might need to know. In amongst that stuff, he showed me that I’d misunderstood something about inputs and client-side prediction.</p>
<h3 id="i-was-wrong">I Was Wrong</h3>
<p>The mistake I’d made (and you can see this if you read <a href="../part5">part 5</a>) was that I thought the clients and server should run at the same tick-rate, and that all client inputs should be simulated in lock-step. For example, if the server was about to simulate tick 100, it would hopefully have received inputs from all connected clients for tick 100, and it would simulate all the players for tick 100, then serialise and send out a snapshot back to all clients. If the server had not received an input from one or more clients for tick 100, then it would just copy whatever input it had from a previous tick. If an input arrived late - too bad, the offending client would probably be getting a correction.</p>
<p>This was wrong. The clients run at whatever speed they can or want to, and send their frame deltas in their input packet, along with the button presses and so on. When the server receives the input packet, it can just carry out the input straight away. So there kind of is no <em><strong>tick 100</strong></em>, the server tick rate just governs how frequently non-player game state (e.g. NPCs) gets updated, but for players it’s effectively more a sample rate.</p>
<p>The beauty of this, is that there’s no such thing as a late input. Even a dropped packet wouldn’t matter most of the time - in each input packet you also provide a bunch of redundant inputs from previous ticks (input data is small, so you can cram in a lot), so if some packets go missing, the server will pick up the lost moves from a later packet. The other advantage is that the client is now no longer forced to tick at the same rate as the server. If the server is ticking at 60, but a player has a low power machine which can only manage 30, they can still play. On the other hand, if their machine is a beast, they can run at 120 and feel the benefit of those extra frames.</p>
<p>The downsides though - firstly, a player running at a higher frame rate will put more strain on the server. A player running at 120 ticks per second will incur 4 times the input processing cost on the server than a player running at 30. For this reason it&rsquo;s a good idea to cap the client simulation frame rate to something sensible. If a player is running at a slower rate than the server then (I think) a solution to this might be to interpolate the player position on the server. So if the server is ticking at 60hz, and the client at 20hz, the server would simulate that client’s inputs, but interpolate the resulting position over 3 ticks.</p>
<p>Second - speed hacks are back. When the simulation is ticked in lock-step it pretty much neutralises speed hacking. However, I think you can solve this problem at the same time as dealing with jitter. As I’ve mentioned in <a href="../part5">part 5</a> network jitter can be greater than you might expect, 1-2 frames at 60hz is a good rule of thumb. Jittering of the input packets arriving at the server will cause the player’s positions to jitter on the server, and then this jittery movement will be observed by players when snapshots make their way to the clients. The solution to this is to measure the jitter for each connected client, and buffer their input packets accordingly. This adds additional latency between clients predicting their actions locally, and having those actions confirmed on the server. By buffering on an individual basis, only the players with jittery connections will be affected. The server can attempt to eat through this buffer at a steady rate. It should be able to speed up and slow down slightly to adapt to changing latency/jitter, but not so much that a speed-hacking client could get much benefit, their buffer would just fill up.</p>
<h3 id="implementation">Implementation</h3>
<p>(Code at this commit on GitHub <a href="https://github.com/spectre1989/odin/tree/9ff85e2a07b590af4b9a4463319dcf762958b2af">here</a>)</p>
<p>So I’ll need to make some changes, though I’m still going to assume no jitter, packet loss, or packet duplication for now. This means that for now I won’t be buffering the inputs on the server for jitter/hacking, and I won’t bother sending redundant inputs in each input packet.</p>
<p>Previously (in my incorrect implementation) my input packets contained the client input and tick number, but also a timestamp. The latter would then be echoed back to the client in the next state packet. This was used to estimate the round-trip time to the server, so that the client could run far enough ahead that its inputs wouldn’t be late.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="send_input_msg%28%0a%20%20%20%20uint32%20client_slot,%0a%20%20%20%20uint8%20input,%0a%20%20%20%20uint32%20timestamp,%0a%20%20%20%20uint32%20tick_number%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">send_input_msg</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">client_slot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint8</span> <span class="n">input</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">tick_number</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Now that I know clients don’t &ldquo;run ahead&rdquo;, I’ll just need to add the client delta time to this, and lose the timestamp. Another thing to point out here is that the client provides a tick number in this packet, that was because the client and server ran at the same tick rate, but that is now not necessarily the case. However, I can’t lose this field from the packet, it will still be needed for correcting client-side prediction when mispredictions occur. When the server tells the client about the game state, the client uses this to find out if their prediction of the local player was correct. The client needs some way of matching that state up with it’s prediction history buffer. So this tick number becomes a local tick number of sorts, which just increases with each client tick - I’ll call this <code>prediction_id</code> so it’s super obvious what it’s for.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="send_input_msg%28%0a%20%20%20%20uint32%20client_slot,%0a%20%20%20%20float32%20dt,%0a%20%20%20%20uint8%20input,%20//%20bitfield%20of%20buttons%20currently%20held%0a%20%20%20%20uint32%20prediction_id%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">send_input_msg</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">client_slot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">float32</span> <span class="n">dt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint8</span> <span class="n">input</span><span class="p">,</span> <span class="c1">// bitfield of buttons currently held
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">uint32</span> <span class="n">prediction_id</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The client stores its prediction history in a circular buffer. The index into the buffer to use is <code>prediction_id % buffer_capacity</code>. If this buffer has a size which is a power of two, then this modulo operation can be done faster with <code>prediction_id &amp; (buffer_capacity - 1)</code>. With a buffer capacity of 512, assuming we cap client frame rate at 120hz, that’s a bit more than 4 seconds worth of buffer, which should be plenty.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Predicted_Move%0a%7b%0a%20%20%20%20float32%20dt;%0a%20%20%20%20Input%20input;%0a%7d;%0a%0aconstexpr%20uint32%20c_buffer_size%20=%20512;%0aconstexpr%20uint32%20c_buffer_mask%20=%20c_buffer_size%20-%201;%0a%0aPredicted_Move%20predicted_move[c_buffer_size];%0aPlayer_State%20predicted_move_result[c_buffer_size];%0a%0aPlayer_State%20player_state;%0auint32%20current_prediction_id;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Predicted_Move</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">float32</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Input</span> <span class="n">input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">constexpr</span> <span class="n">uint32</span> <span class="n">c_buffer_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">constexpr</span> <span class="n">uint32</span> <span class="n">c_buffer_mask</span> <span class="o">=</span> <span class="n">c_buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Predicted_Move</span> <span class="n">predicted_move</span><span class="p">[</span><span class="n">c_buffer_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">Player_State</span> <span class="n">predicted_move_result</span><span class="p">[</span><span class="n">c_buffer_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Player_State</span> <span class="n">player_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">uint32</span> <span class="n">current_prediction_id</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The client loop will look something like this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="while%20%28true%29%0a%7b%0a%20%20%20%20//%20send%20input%20to%20server%0a%20%20%20%20send_input_msg%28client_slot,%20dt,%20input,%20current_prediction_id%29;%0a%0a%20%20%20%20//%20update%20player%20state%0a%20%20%20%20tick_player%28&amp;player_state,%20dt,%20input%29;%0a%0a%20%20%20%20uint32%20buffer_index%20=%20current_prediction_id%20&amp;%20c_buffer_mask;%0a%0a%20%20%20%20//%20record%20dt%20and%20input%20in%20the%20buffer%20for%20this%20tick,%20so%20it%20can%20be%20replayed%20if%20necessary%0a%20%20%20%20predicted_move[buffer_index].dt%20=%20dt;%0a%20%20%20%20predicted_move[buffer_index].input%20=%20input;%0a%20%20%20%20%0a%20%20%20%20//%20record%20resulting%20player%20state%20so%20we%20can%20tell%20when%20the%20client%20has%20gone%20out%20of%20sync%20with%20the%20server%0a%20%20%20%20predicted_move_result[buffer_index]%20=%20player_state;%0a%20%20%20%20%0a%20%20%20%20&#43;&#43;current_prediction_id;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// send input to server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">send_input_msg</span><span class="p">(</span><span class="n">client_slot</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">current_prediction_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// update player state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tick_player</span><span class="p">(</span><span class="o">&amp;</span><span class="n">player_state</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">buffer_index</span> <span class="o">=</span> <span class="n">current_prediction_id</span> <span class="o">&amp;</span> <span class="n">c_buffer_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// record dt and input in the buffer for this tick, so it can be replayed if necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">predicted_move</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">predicted_move</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// record resulting player state so we can tell when the client has gone out of sync with the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">predicted_move_result</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">player_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">current_prediction_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>So what the buffers are storing is - at prediction id <code>x</code>, dt was <code>a</code>, input was <code>b</code>, and the resulting player state was <code>c</code>.</p>
<p>The server loop will look like this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="while%20%28true%29%0a%7b%0a%20%20%20%20while%20%28Msg*%20msg%20=%20get_next_message%28%29%29%0a%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20switch%20%28msg-%3etype%29%0a%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20//%20...%0a%20%20%20%20%20%20%20%20%20%20%20%20%0a%20%20%20%20%20%20%20%20%20%20%20%20case%20Input:%0a%20%20%20%20%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tick_player%28&amp;player_state[msg-%3eslot],%20msg-%3edt,%20msg-%3einput%29;%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20player_prediction_id[slot]%20=%20msg-%3eprediction_id;%0a%20%20%20%20%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20%20%20%20%20%20%20break:%0a%20%20%20%20%20%20%20%20%20%20%20%20%0a%20%20%20%20%20%20%20%20%20%20%20%20//%20...%0a%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%7d%0a%20%20%20%20%0a%20%20%20%20for%20%28int32%20slot%20=%200;%20slot%20%3c%20c_max_clients;%20&#43;&#43;slot%29%0a%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20if%20%28client[slot]%29%0a%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20send_state_msg%28slot,%20player_prediction_id[slot],%20&amp;player_state[slot],%20&amp;other_game_state%29;%0a%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%7d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">Msg</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">get_next_message</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">Input</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tick_player</span><span class="p">(</span><span class="o">&amp;</span><span class="n">player_state</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">player_prediction_id</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">prediction_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">int32</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">c_max_clients</span><span class="p">;</span> <span class="o">++</span><span class="n">slot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">send_state_msg</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">player_prediction_id</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_state</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">other_game_state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Then when the client receives a state message from the server:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="uint32%20buffer_index%20=%20msg-%3eprediction_id%20&amp;%20c_buffer_mask;%0aVec_3f%20error%20=%20predicted_move_result[buffer_index].position%20-%20msg-%3eplayer_state.position;%0aif%20%28error.length_squared%28%29%20%3e%20c_max_prediction_error_squared%29%0a%7b%0a%20%20%20%20player_state%20=%20msg-%3eplayer_state;%0a%20%20%20%20%0a%20%20%20%20for%20%28uint32%20replaying_prediction_id%20=%20msg-%3eprediction_id%20&#43;%201;%0a%20%20%20%20%20%20%20%20replaying_prediction_id%20%3c%20current_prediction_id;%0a%20%20%20%20%20%20%20%20&#43;&#43;replaying_prediction_id%29%0a%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20buffer_index%20=%20replaying_prediction_id%20&amp;%20c_buffer_mask;%0a%20%20%20%20%20%20%20%20%0a%20%20%20%20%20%20%20%20tick_player%28&amp;player_state,%20predicted_move[buffer_index].dt,%20predicted_move[buffer_index].input%29;%0a%20%20%20%20%20%20%20%20%0a%20%20%20%20%20%20%20%20predicted_move_result[buffer_index]%20=%20player_state;%0a%20%20%20%20%7d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">uint32</span> <span class="n">buffer_index</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">prediction_id</span> <span class="o">&amp;</span> <span class="n">c_buffer_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Vec_3f</span> <span class="n">error</span> <span class="o">=</span> <span class="n">predicted_move_result</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">position</span> <span class="o">-</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">player_state</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">length_squared</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">c_max_prediction_error_squared</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">player_state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">player_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">uint32</span> <span class="n">replaying_prediction_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">prediction_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">replaying_prediction_id</span> <span class="o">&lt;</span> <span class="n">current_prediction_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">++</span><span class="n">replaying_prediction_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer_index</span> <span class="o">=</span> <span class="n">replaying_prediction_id</span> <span class="o">&amp;</span> <span class="n">c_buffer_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">tick_player</span><span class="p">(</span><span class="o">&amp;</span><span class="n">player_state</span><span class="p">,</span> <span class="n">predicted_move</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">dt</span><span class="p">,</span> <span class="n">predicted_move</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">predicted_move_result</span><span class="p">[</span><span class="n">buffer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">player_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<h3 id="a-change-of-perspective">A Change of Perspective</h3>
<p>So far my player has been a weird sort of third-person cube car thing. It’s about time to actually switch to a first-person controller as the project demands.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ANEuTkpDmeg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>This requires some changes to the networking of inputs, as we now have to incorporate mouse input. Along with sending the buttons held down, we also need the pitch/yaw of the player. Actually - we don’t yet <em>need</em> the pitch as it’s not used for movement, but we will need it for shooting, so I’ll just add it now.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="send_input_msg%28%0a%20%20%20%20uint32%20client_slot,%0a%20%20%20%20float32%20dt,%0a%20%20%20%20uint8%20buttons,%20//%20bitfield%20of%20buttons%20currently%20held%0a%20%20%20%20float32%20pitch,%0a%20%20%20%20float32%20yaw,%0a%20%20%20%20uint32%20prediction_id%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">send_input_msg</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">client_slot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">float32</span> <span class="n">dt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint8</span> <span class="n">buttons</span><span class="p">,</span> <span class="c1">// bitfield of buttons currently held
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">float32</span> <span class="n">pitch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">float32</span> <span class="n">yaw</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint32</span> <span class="n">prediction_id</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>You could be forgiven for thinking that for preventing cheating you should not send raw pitch and yaw, and instead send deltas from the previous pitch and yaw. This is a waste of time, anyone aim-botting etc will be able to figure out sending deltas, while you run the risk of legitimate players having their pitch/yaw get out of sync with the server because of a burst of packet loss or a bug.</p>
<p>That’s about it for the re-working of client-side prediction. It’s still not finished of course, we need to deal with packet loss, jitter, potential malicious packets, cheating, and probably more. It’s enough for now to move forward.</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            

            
                <li>Joe Best-Rotheray</li>
            

            
                
                    <li>
                        
                            <a href="mailto:joe@codersblock.org" target="_blank">
                                <i class="bi-envelope"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="spectre1989" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="joebestrotheray" target="_blank">
                                <i class="bi-linkedin"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
                    <li>
                        
                            <a href="codersblock" target="_blank">
                                <i class="bi-twitter"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1847
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.121.2</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Jun 07 2019 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
