<!DOCTYPE html>
<html lang="en-gb">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.121.2">

    

    

    
        
            <meta
                name="description"
                content="Adventures in netcode, game engines, and game development" />
        

        
            <meta
                name="keywords"
                content="netcode,programming,gamedev,c&#43;&#43;,unreal,UE5,unity,games,sockets" />
        

        
            <meta
                name="author"
                content="Joe Best-Rotheray" />
        

    


    <title>
        
            Making a Multiplayer FPS in C&#43;&#43; Part 2: The Main Loop |
            
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    
        
            
            
        
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_b09f3b5.min.ef4c9eaae329b6fd531cbd1b46bea7ef3c2a6379278996939587ba222c0e3e471a59dd031f1797fd0b9922011d5b29dd10bab501b2b80f2eec99b4028d35249c.css"
            integrity="sha512-70yequMptv1THL0bRr6n7zwqY3kniZaTlYe6IiwOPkcaWd0DHxeX/QuZIgEdWyndELq1AbK4Dy7smbQCjTUknA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Making a Multiplayer FPS in C&#43;&#43; Part 2: The Main Loop -
            
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Making a Multiplayer FPS in C&#43;&#43; </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part8/" title="./multiplayer-fps/part8/">
                         Part 8: Client-Side Prediction Revisited 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part7/" title="./multiplayer-fps/part7/">
                         Part 7: The Vulkan Projection Matrix 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part6/" title="./multiplayer-fps/part6/">
                         Part 6: Cleanup 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part5/" title="./multiplayer-fps/part5/">
                         Part 5: Client-Side Prediction 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part4/" title="./multiplayer-fps/part4/">
                         Part 4: Rebuilding The Client in C&#43;&#43; 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part3/" title="./multiplayer-fps/part3/">
                         Part 3: Multiple Players 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part2/" title="./multiplayer-fps/part2/">
                         Part 2: The Main Loop 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part1/" title="./multiplayer-fps/part1/">
                         Part 1: Hello Multiplayer World 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/unity-client-side-prediction/" title="./posts/unity-client-side-prediction/">
                         Client-Side Prediction With Physics In Unity 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/ditching-the-mutex/" title="./posts/ditching-the-mutex/">
                         Ditching the Mutex 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>


        
            <div class="headerLogo">
                <a href="https://codersblock.org/"><img src="https://codersblock.org/images/logo.png"/></a>
            </div>
        
        <div class="title">
            <h1 class="title-header">
                Making a Multiplayer FPS in C&#43;&#43; Part 2: The Main Loop
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/joe-best-rotheray/"
                                class="cat-btn">
                                Joe Best-Rotheray
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2016.08.21"
                            >2016.08.21
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        10 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="https://codersblock.org/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/" class="bread-btn">
    

    
        Making a Multiplayer FPS in C&#43;&#43;
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/part2/" class="bread-btn">
    

    
        Part 2: The Main Loop
    
</a>

                </div>
            

            
        </div>

        
            

        


        <div class="content">
            
                <p>The previous part of this series was at best the &ldquo;Hello, world!&rdquo; stage of an online game. Now it&rsquo;s time to actually start actually laying the groundwork.</p>
<h3 id="the-input-loop">The Input Loop</h3>
<p>Back in the day when multiplayer games were only played on a LAN, the clients would collect their user input, and send it to the server. The server would wait until it had the input from all clients, and then tick the game simulation, and send back the new game state. This is viable on a LAN because latency is so low, but it&rsquo;s not workable today, input lag of even a hundred milliseconds would feel sluggish, let alone two or three.</p>
<p>For now, I&rsquo;ll be doing LAN-style netcode - don&rsquo;t worry, it shouldn&rsquo;t remain like this for long, but it&rsquo;ll help simplify things at this early stage.</p>
<h3 id="starting-slow">Starting Slow</h3>
<p>I started with a text adventure-ish input loop, browse the repository at this commit <a href="https://github.com/spectre1989/odin/tree/c10d34fc1ce3dc523e62e1f4f47b928a42e879cb">here</a>. This is how the server now begins (I won&rsquo;t include the code for creating and binding the socket from before):</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="int8%20buffer[SOCKET_BUFFER_SIZE];%0aint32%20player_x%20=%200;%0aint32%20player_y%20=%200;%0a%0abool32%20is_running%20=%201;%0awhile%28%20is_running%20%29%0a%7b%0a%20%20%20//%20get%20input%20packet%20from%20player%0a%20%20%20int%20flags%20=%200;%0a%20%20%20SOCKADDR_IN%20from;%0a%20%20%20int%20from_size%20=%20sizeof%28%20from%20%29;%0a%20%20%20int%20bytes_received%20=%20recvfrom%28%20sock,%20buffer,%20SOCKET_BUFFER_SIZE,%20flags,%20%28SOCKADDR*%29&amp;from,%20&amp;from_size%20%29;%0a%20%20%20%0a%20%20%20if%28%20bytes_received%20==%20SOCKET_ERROR%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20printf%28%20%22recvfrom%20returned%20SOCKET_ERROR,%20WSAGetLastError%28%29%20%25d%22,%20WSAGetLastError%28%29%20%29;%0a%20%20%20%20%20%20break;%0a%20%20%20%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">int8</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SOCKET_BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">int32</span> <span class="n">player_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">int32</span> <span class="n">player_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bool32</span> <span class="n">is_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// get input packet from player
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">SOCKADDR_IN</span> <span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">from_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">from</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">SOCKET_BUFFER_SIZE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_size</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">bytes_received</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;recvfrom returned SOCKET_ERROR, WSAGetLastError() %d&#34;</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The first thing I&rsquo;ll point out is how at this point I started using typedefs like <code>int32</code>, I just like to show exactly how many bits are being used for basic types, and I don&rsquo;t like writing <code>unsigned int</code>, I far prefer <code>uint32</code>. Generally my style is to use these typedefs for all game code, but when I&rsquo;m using Windows API functions I use whichever silly types they specify in the documentation on MSDN, e.g. <code>UINT</code>, <code>DWORD</code>, etc.</p>
<p>The <code>recvfrom</code> is essentially the same as before, but now this will be called in a loop. The only actual game state at this stage is the player x and y values, so they live outside the loop. On to processing the client packet:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="//%20process%20input%0achar%20client_input%20=%20buffer[0];%0aprintf%28%20%22%25d.%25d.%25d.%25d:%25d%20-%20%25c%5cn%22,%20from.sin_addr.S_un.S_un_b.s_b1,%20from.sin_addr.S_un.S_un_b.s_b2,%20from.sin_addr.S_un.S_un_b.s_b3,%20from.sin_addr.S_un.S_un_b.s_b4,%20from.sin_port,%20client_input%20%29;%0a%0aswitch%28%20client_input%20%29%0a%7b%0a%20%20%20case%20%27w%27:%0a%20%20%20%20%20%20&#43;&#43;player_y;%0a%20%20%20break;%0a%0a%20%20%20case%20%27a%27:%0a%20%20%20%20%20%20--player_x;%0a%20%20%20break;%0a%0a%20%20%20case%20%27s%27:%0a%20%20%20%20%20%20--player_y;%0a%20%20%20break;%0a%0a%20%20%20case%20%27d%27:%0a%20%20%20%20%20%20&#43;&#43;player_x;%0a%20%20%20break;%0a%0a%20%20%20case%20%27q%27:%0a%20%20%20%20%20%20is_running%20=%200;%0a%20%20%20break;%0a%0a%20%20%20default:%0a%20%20%20%20%20%20printf%28%20%22unhandled%20input%20%25c%5cn%22,%20client_input%20%29;%0a%20%20%20break;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// process input
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">client_input</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span> <span class="s">&#34;%d.%d.%d.%d:%d - %c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b1</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b2</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b3</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b4</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span> <span class="n">client_input</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">switch</span><span class="p">(</span> <span class="n">client_input</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">player_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">--</span><span class="n">player_x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">--</span><span class="n">player_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">player_x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="sc">&#39;q&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">is_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;unhandled input %c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">client_input</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The server just expects a single character for input w/a/s/d to move, and q to quit. Now to create the state packet and send it back to the player:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="//%20create%20state%20packet%0aint32%20write_index%20=%200;%0amemcpy%28%20&amp;buffer[write_index],%20&amp;player_x,%20sizeof%28%20player_x%20%29%20%29;%0awrite_index%20&#43;=%20sizeof%28%20player_x%20%29;%0a%0amemcpy%28%20&amp;buffer[write_index],%20&amp;player_y,%20sizeof%28%20player_y%20%29%20%29;%0awrite_index%20&#43;=%20sizeof%28%20player_y%20%29;%0a%0amemcpy%28%20&amp;buffer[write_index],%20&amp;is_running,%20sizeof%28%20is_running%20%29%20%29;%0a%0a//%20send%20back%20to%20client%0aint%20buffer_length%20=%20sizeof%28%20player_x%20%29%20&#43;%20sizeof%28%20player_y%20%29%20&#43;%20sizeof%28%20is_running%20%29;%0aflags%20=%200;%0aSOCKADDR*%20to%20=%20%28SOCKADDR*%29&amp;from;%0aint%20to_length%20=%20sizeof%28%20from%20%29;%0aif%28%20sendto%28%20sock,%20buffer,%20buffer_length,%20flags,%20to,%20to_length%20%29%20==%20SOCKET_ERROR%20%29%0a%7b%0a%20%20%20printf%28%20%22sendto%20failed:%20%25d%22,%20WSAGetLastError%28%29%20%29;%0a%20%20%20return;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// create state packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">int32</span> <span class="n">write_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">write_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">write_index</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">write_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_y</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">write_index</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">write_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">is_running</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// send back to client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">buffer_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">to_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">from</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">sendto</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_length</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">to_length</span> <span class="p">)</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;sendto failed: %d&#34;</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The game state is copied into the buffer using <code>memcpy</code>, and sent like we saw last time with <code>sendto</code>. Now for the client:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="int8%20buffer[SOCKET_BUFFER_SIZE];%0aint32%20player_x;%0aint32%20player_y;%0a%0aprintf%28%20%22type%20w,%20a,%20s,%20or%20d%20to%20move,%20q%20to%20quit%5cn%22%20%29;%0abool32%20is_running%20=%201;%0awhile%28%20is_running%20%29%0a%7b%0a%20%20%20//%20get%20input%0a%20%20%20scanf_s%28%20%22%5cn%25c%22,%20&amp;buffer[0],%201%20%29;%0a%0a%20%20%20//%20send%20to%20server%0a%20%20%20int%20buffer_length%20=%201;%0a%20%20%20int%20flags%20=%200;%0a%20%20%20SOCKADDR*%20to%20=%20%28SOCKADDR*%29&amp;server_address;%0a%20%20%20int%20to_length%20=%20sizeof%28%20server_address%20%29;%0a%20%20%20if%28%20sendto%28%20sock,%20buffer,%20buffer_length,%20flags,%20to,%20to_length%20%29%20==%20SOCKET_ERROR%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20printf%28%20%22sendto%20failed:%20%25d%22,%20WSAGetLastError%28%29%20%29;%0a%20%20%20%20%20%20return;%0a%20%20%20%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">int8</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SOCKET_BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">int32</span> <span class="n">player_x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">int32</span> <span class="n">player_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span> <span class="s">&#34;type w, a, s, or d to move, q to quit</span><span class="se">\n</span><span class="s">&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">bool32</span> <span class="n">is_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// get input
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">scanf_s</span><span class="p">(</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">%c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// send to server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="kt">int</span> <span class="n">buffer_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">to_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">server_address</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">sendto</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_length</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">to_length</span> <span class="p">)</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;sendto failed: %d&#34;</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Input is collected from the console using <code>scanf_s</code>, straight in to the buffer, and that single byte is sent the same way as before with <code>sendto</code>.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20//%20wait%20for%20reply%0a%20%20%20flags%20=%200;%0a%20%20%20SOCKADDR_IN%20from;%0a%20%20%20int%20from_size%20=%20sizeof%28%20from%20%29;%0a%20%20%20int%20bytes_received%20=%20recvfrom%28%20sock,%20buffer,%20SOCKET_BUFFER_SIZE,%20flags,%20%28SOCKADDR*%29&amp;from,%20&amp;from_size%20%29;%0a%20%20%20%0a%20%20%20if%28%20bytes_received%20==%20SOCKET_ERROR%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20printf%28%20%22recvfrom%20returned%20SOCKET_ERROR,%20WSAGetLastError%28%29%20%25d%22,%20WSAGetLastError%28%29%20%29;%0a%20%20%20%20%20%20break;%0a%20%20%20%7d%0a%0a%20%20%20//%20grab%20data%20from%20packet%0a%20%20%20int32%20read_index%20=%200;%0a%0a%20%20%20memcpy%28%20&amp;player_x,%20&amp;buffer[read_index],%20sizeof%28%20player_x%20%29%20%29;%0a%20%20%20read_index%20&#43;=%20sizeof%28%20player_x%20%29;%0a%0a%20%20%20memcpy%28%20&amp;player_y,%20&amp;buffer[read_index],%20sizeof%28%20player_y%20%29%20%29;%0a%20%20%20read_index%20&#43;=%20sizeof%28%20player_y%20%29;%0a%0a%20%20%20memcpy%28%20&amp;is_running,%20&amp;buffer[read_index],%20sizeof%28%20is_running%20%29%20%29;%0a%0a%20%20%20printf%28%20%22x:%25d,%20y:%25d,%20is_running:%25d%5cn%22,%20player_x,%20player_y,%20is_running%20%29;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="c1">// wait for reply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">SOCKADDR_IN</span> <span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">from_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">from</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">SOCKET_BUFFER_SIZE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_size</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">bytes_received</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;recvfrom returned SOCKET_ERROR, WSAGetLastError() %d&#34;</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// grab data from packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">int32</span> <span class="n">read_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">player_x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">read_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">read_index</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">player_y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">read_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">read_index</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">is_running</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">read_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;x:%d, y:%d, is_running:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">,</span> <span class="n">is_running</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The client waits for the state packet, unpacks it, and displays the result in the console, before continuing for the next iteration of the loop.</p>
<h3 id="speeding-up">Speeding Up</h3>
<p>This is all well and good so far, but I want my game to be real-time, which will require the loop to run many times per second. The client is also going to have to cease being a console application. Given that the server is the focus of this project, for now I&rsquo;ll use Unity to throw something together quickly and easily. The code for the client will be included in the repository, but I won&rsquo;t go through it here, it&rsquo;s all very simple though. Here are the changes I made to the server, browse the repository at this commit <a href="https://github.com/spectre1989/odin/tree/155a877644a1c846297af589087085835feed2df">here</a>.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="int8%20buffer[SOCKET_BUFFER_SIZE];%0afloat32%20player_x%20=%200.0f;%0afloat32%20player_y%20=%200.0f;%0afloat32%20player_facing%20=%200.0f;%0afloat32%20player_speed%20=%200.0f;%0a%0abool32%20is_running%20=%201;%0awhile%28%20is_running%20%29%0a%7b">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">int8</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SOCKET_BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">float32</span> <span class="n">player_x</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">float32</span> <span class="n">player_y</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">float32</span> <span class="n">player_facing</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">float32</span> <span class="n">player_speed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bool32</span> <span class="n">is_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>I thought I&rsquo;d make the player object some kind of vehicle, so some extra game state will be needed. As before there&rsquo;ll be <code>player_x</code> and <code>player_y</code>, but now there&rsquo;ll be <code>player_facing</code>. This needs only be a single <code>float32</code> to describe their rotation, as they will only rotate around the z-axis. Finally there&rsquo;s <code>player_speed</code>, this is how fast they move in whatever direction they&rsquo;re facing.</p>
<p>The player will push the w/s keys to speed up and slow down, and a/d keys to turn. Client input is received by the server in the same manner as before, but we&rsquo;ll pick up at the point where the input is processed:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20//%20process%20input%20and%20update%20state%0a%20%20%20int8%20client_input%20=%20buffer[0];%0a%20%20%20printf%28%20%22%25d.%25d.%25d.%25d:%25d%20-%20%25d%5cn%22,%20from.sin_addr.S_un.S_un_b.s_b1,%20from.sin_addr.S_un.S_un_b.s_b2,%20from.sin_addr.S_un.S_un_b.s_b3,%20from.sin_addr.S_un.S_un_b.s_b4,%20from.sin_port,%20client_input%20%29;%0a%0a%20%20%20if%28%20client_input%20&amp;%200x1%20%29%20%20%20//%20forward%0a%20%20%20%7b%0a%20%20%20%20%20%20player_speed%20&#43;=%20ACCELERATION;%0a%20%20%20%20%20%20if%28%20player_speed%20%3e%20MAX_SPEED%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20player_speed%20=%20MAX_SPEED;%0a%20%20%20%20%20%20%7d%0a%20%20%20%7d%0a%20%20%20if%28%20client_input%20&amp;%200x2%20%29%20%20%20//%20back%0a%20%20%20%7b%0a%20%20%20%20%20%20player_speed%20-=%20ACCELERATION;%0a%20%20%20%20%20%20if%28%20player_speed%20%3c%200.0f%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20player_speed%20=%200.0f;%0a%20%20%20%20%20%20%7d%0a%20%20%20%7d%0a%20%20%20if%28%20client_input%20&amp;%200x4%20%29%20%20%20//%20left%0a%20%20%20%7b%0a%20%20%20%20%20%20player_facing%20-=%20TURN_SPEED;%0a%20%20%20%7d%0a%20%20%20if%28%20client_input%20&amp;%200x8%20%29%20%20%20//%20right%0a%20%20%20%7b%0a%20%20%20%20%20%20player_facing%20&#43;=%20TURN_SPEED;%0a%20%20%20%7d%0a%0a%20%20%20player_x%20&#43;=%20player_speed%20*%20sinf%28%20player_facing%20%29;%0a%20%20%20player_y%20&#43;=%20player_speed%20*%20cosf%28%20player_facing%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="c1">// process input and update state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">int8</span> <span class="n">client_input</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;%d.%d.%d.%d:%d - %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b1</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b2</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b3</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_un_b</span><span class="p">.</span><span class="n">s_b4</span><span class="p">,</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span> <span class="n">client_input</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_input</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="p">)</span>   <span class="c1">// forward
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">player_speed</span> <span class="o">+=</span> <span class="n">ACCELERATION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">player_speed</span> <span class="o">&gt;</span> <span class="n">MAX_SPEED</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">player_speed</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_input</span> <span class="o">&amp;</span> <span class="mh">0x2</span> <span class="p">)</span>   <span class="c1">// back
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">player_speed</span> <span class="o">-=</span> <span class="n">ACCELERATION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">player_speed</span> <span class="o">&lt;</span> <span class="mf">0.0f</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">player_speed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_input</span> <span class="o">&amp;</span> <span class="mh">0x4</span> <span class="p">)</span>   <span class="c1">// left
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">player_facing</span> <span class="o">-=</span> <span class="n">TURN_SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_input</span> <span class="o">&amp;</span> <span class="mh">0x8</span> <span class="p">)</span>   <span class="c1">// right
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">player_facing</span> <span class="o">+=</span> <span class="n">TURN_SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">player_x</span> <span class="o">+=</span> <span class="n">player_speed</span> <span class="o">*</span> <span class="n">sinf</span><span class="p">(</span> <span class="n">player_facing</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">player_y</span> <span class="o">+=</span> <span class="n">player_speed</span> <span class="o">*</span> <span class="n">cosf</span><span class="p">(</span> <span class="n">player_facing</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Unlike the previous iteration, the player can now press multiple keys at once, so all four keys are combined into a single byte. The first four bits of the byte indicate if the keys for forward, back, left, and right respectively, are held. The rest of the byte is unused for now. These four inputs update the player speed and facing, and finally this is used to update the position of the player. This is a very wonky approximation of physics, but it can be improved upon later.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20//%20create%20state%20packet%0a%20%20%20int32%20bytes_written%20=%200;%0a%20%20%20memcpy%28%20&amp;buffer[bytes_written],%20&amp;player_x,%20sizeof%28%20player_x%20%29%20%29;%0a%20%20%20bytes_written%20&#43;=%20sizeof%28%20player_x%20%29;%0a%0a%20%20%20memcpy%28%20&amp;buffer[bytes_written],%20&amp;player_y,%20sizeof%28%20player_y%20%29%20%29;%0a%20%20%20bytes_written%20&#43;=%20sizeof%28%20player_y%20%29;%0a%0a%20%20%20memcpy%28%20&amp;buffer[bytes_written],%20&amp;player_facing,%20sizeof%28%20player_facing%20%29%20%29;%0a%20%20%20bytes_written%20&#43;=%20sizeof%28%20player_facing%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="c1">// create state packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">int32</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_y</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_y</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">player_facing</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_facing</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">player_facing</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Finally the state packet is written, this time incorporating the player facing as well.</p>
<h3 id="fixing-the-tick-rate">Fixing The Tick Rate</h3>
<p>Currently the server is not measuring the time between loop iterations, so the simulation speed will be different depending on the hardware it&rsquo;s run on, so I&rsquo;ll fix the tick rate to 60hz.</p>
<p>What we&rsquo;ll do is, measure the time that each tick takes, and then wait until it&rsquo;s time to start the next tick. We could just spin in a loop until that time is up, but that&rsquo;ll waste a lot of processing power. We&rsquo;ll put our thread to sleep using the <code>sleep</code> function:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="VOID%20WINAPI%20Sleep%28%0a%20%20_In_%20DWORD%20dwMilliseconds%0a%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="n">WINAPI</span> <span class="nf">Sleep</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">dwMilliseconds</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>This has two problems though, firstly we can only specify the time to sleep in milliseconds, so we&rsquo;ll have to spin in a loop for any time which is less than a millisecond. Secondly, the windows scheduler itself might only check to see if it needs to wake up our thread once every ten milliseconds. For this reason, we&rsquo;ll have to attempt to set the granularity of the scheduler using <code>timeBeginPeriod</code>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="MMRESULT%20timeBeginPeriod%28%0a%20%20%20UINT%20uPeriod%0a%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">MMRESULT</span> <span class="nf">timeBeginPeriod</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="n">UINT</span> <span class="n">uPeriod</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Note - the documentation on MSDN says &ldquo;You must match each call to timeBeginPeriod with a call to timeEndPeriod&rdquo;, as is often the case with MSDN <a href="https://randomascii.wordpress.com/2013/07/08/windows-timer-resolution-megawatts-wasted/">this is not true</a>! Windows will clean this up for you after the application exits, you only need to call <code>timeEndPeriod</code> if you no longer need the granularity, but your program will continue running.</p>
<p>We can record a timestamp using the Windows API function <code>QueryPerformanceCounter</code>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="BOOL%20WINAPI%20QueryPerformanceCounter%28%0a%20%20_Out_%20LARGE_INTEGER%20*lpPerformanceCount%0a%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">QueryPerformanceCounter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">_Out_</span> <span class="n">LARGE_INTEGER</span> <span class="o">*</span><span class="n">lpPerformanceCount</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>This returns a measurement of time, but that measurement is not known at compile time (e.g. microseconds, nanoseconds etc). To convert it to some denomination of seconds, we need to also call <code>QueryPerformanceFrequency</code>, which will tell us how many counts there are per second:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="BOOL%20WINAPI%20QueryPerformanceFrequency%28%0a%20%20_Out_%20LARGE_INTEGER%20*lpFrequency%0a%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">QueryPerformanceFrequency</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">_Out_</span> <span class="n">LARGE_INTEGER</span> <span class="o">*</span><span class="n">lpFrequency</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>You can browse the code at the relevant commit <a href="https://github.com/spectre1989/odin/tree/c0d1581870d996425257411fb8e2bc35eac894e9">here</a>, I started with the following code before the server loop begins:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="UINT%20sleep_granularity_ms%20=%201;%0abool32%20sleep_granularity_was_set%20=%20timeBeginPeriod%28%20sleep_granularity_ms%20%29%20==%20TIMERR_NOERROR;%0a%0aLARGE_INTEGER%20clock_frequency;%0aQueryPerformanceFrequency%28%20&amp;clock_frequency%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">UINT</span> <span class="n">sleep_granularity_ms</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">bool32</span> <span class="n">sleep_granularity_was_set</span> <span class="o">=</span> <span class="n">timeBeginPeriod</span><span class="p">(</span> <span class="n">sleep_granularity_ms</span> <span class="p">)</span> <span class="o">==</span> <span class="n">TIMERR_NOERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LARGE_INTEGER</span> <span class="n">clock_frequency</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">QueryPerformanceFrequency</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">clock_frequency</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Then at the start of a loop, we record the current time:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="while%28%20is_running%20%29%0a%7b%0a%20%20%20LARGE_INTEGER%20tick_start_time;%0a%20%20%20QueryPerformanceCounter%28%20&amp;tick_start_time%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span> <span class="n">is_running</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">LARGE_INTEGER</span> <span class="n">tick_start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">QueryPerformanceCounter</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">tick_start_time</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>In all the places where the player changes speed and turns, we need to take the length of a tick in to account (well, we don&rsquo;t need to at all actually, but this will massively reduce headaches if we decide to change the tick rate later):</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20player_speed%20&#43;=%20ACCELERATION%20*%20SECONDS_PER_TICK;%0a%20%20%20//%20...%0a%20%20%20player_facing%20&#43;=%20TURN_SPEED%20*%20SECONDS_PER_TICK;%0a%20%20%20//%20...%0a%20%20%20player_x%20&#43;=%20player_speed%20*%20SECONDS_PER_TICK%20*%20sinf%28%20player_facing%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="n">player_speed</span> <span class="o">+=</span> <span class="n">ACCELERATION</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">player_facing</span> <span class="o">+=</span> <span class="n">TURN_SPEED</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">player_x</span> <span class="o">+=</span> <span class="n">player_speed</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span> <span class="o">*</span> <span class="n">sinf</span><span class="p">(</span> <span class="n">player_facing</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Then at the end of the tick we measure how much time has elapsed since the beginning of the loop, I wrote a convenience function for this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="static%20float32%20time_since%28%20LARGE_INTEGER%20t,%20LARGE_INTEGER%20frequency%20%29%0a%7b%0a%20%20%20LARGE_INTEGER%20now;%0a%20%20%20QueryPerformanceCounter%28%20&amp;now%20%29;%0a%0a%20%20%20return%20float32%28%20now.QuadPart%20-%20t.QuadPart%20%29%20/%20float32%28%20frequency.QuadPart%20%29;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">float32</span> <span class="nf">time_since</span><span class="p">(</span> <span class="n">LARGE_INTEGER</span> <span class="n">t</span><span class="p">,</span> <span class="n">LARGE_INTEGER</span> <span class="n">frequency</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">LARGE_INTEGER</span> <span class="n">now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">QueryPerformanceCounter</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">now</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">float32</span><span class="p">(</span> <span class="n">now</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-</span> <span class="n">t</span><span class="p">.</span><span class="n">QuadPart</span> <span class="p">)</span> <span class="o">/</span> <span class="n">float32</span><span class="p">(</span> <span class="n">frequency</span><span class="p">.</span><span class="n">QuadPart</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Back to the code that goes at the end of the loop:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20float32%20time_taken_s%20=%20time_since%28%20tick_start_time,%20clock_frequency%20%29;%0a%0a%20%20%20while%28%20time_taken_s%20%3c%20SECONDS_PER_TICK%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20if%28%20sleep_granularity_was_set%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20DWORD%20time_to_wait_ms%20=%20DWORD%28%20%28%20SECONDS_PER_TICK%20-%20time_taken_s%20%29%20*%201000%20%29;%0a%20%20%20%20%20%20%20%20%20if%28%20time_to_wait_ms%20%3e%200%20%29%0a%20%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20Sleep%28%20time_to_wait_ms%20%29;%0a%20%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20%7d%0a%0a%20%20%20%20%20%20time_taken_s%20=%20time_since%28%20tick_start_time,%20clock_frequency%20%29;%0a%20%20%20%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="n">float32</span> <span class="n">time_taken_s</span> <span class="o">=</span> <span class="n">time_since</span><span class="p">(</span> <span class="n">tick_start_time</span><span class="p">,</span> <span class="n">clock_frequency</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">while</span><span class="p">(</span> <span class="n">time_taken_s</span> <span class="o">&lt;</span> <span class="n">SECONDS_PER_TICK</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">sleep_granularity_was_set</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">DWORD</span> <span class="n">time_to_wait_ms</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">(</span> <span class="p">(</span> <span class="n">SECONDS_PER_TICK</span> <span class="o">-</span> <span class="n">time_taken_s</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span><span class="p">(</span> <span class="n">time_to_wait_ms</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleep</span><span class="p">(</span> <span class="n">time_to_wait_ms</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">time_taken_s</span> <span class="o">=</span> <span class="n">time_since</span><span class="p">(</span> <span class="n">tick_start_time</span><span class="p">,</span> <span class="n">clock_frequency</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Notice that sleep is only called if the call to <code>timeBeginPeriod</code> actually succeeded earlier, if for some reason it failed then we&rsquo;ll just have to spin in the loop. When calculating how many milliseconds to sleep for, if we have 1.99 milliseconds left until the next tick begins, then we only sleep for 1 millisecond, and then spin for the remaining 0.99. This is why the calculation of <code>time_to_wait_ms</code> is truncated rather than rounded.</p>
<p>And that&rsquo;s it!</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            

            
                <li>Joe Best-Rotheray</li>
            

            
                
                    <li>
                        
                            <a href="mailto:joe@codersblock.org" target="_blank">
                                <i class="bi-envelope"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="spectre1989" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="joebestrotheray" target="_blank">
                                <i class="bi-linkedin"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
                    <li>
                        
                            <a href="codersblock" target="_blank">
                                <i class="bi-twitter"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        2091
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.121.2</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Aug 21 2016 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
