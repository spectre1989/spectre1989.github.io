<!DOCTYPE html>
<html lang="en-gb">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.121.2">

    

    

    
        
            <meta
                name="description"
                content="Adventures in netcode, game engines, and game development" />
        

        
            <meta
                name="keywords"
                content="netcode,programming,gamedev,c&#43;&#43;,unreal,UE5,unity,games,sockets" />
        

        
            <meta
                name="author"
                content="Joe Best-Rotheray" />
        

    


    <title>
        
            Making a Multiplayer FPS in C&#43;&#43; Part 3: Multiple Players |
            
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    
        
            
            
        
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_b09f3b5.min.981b5487040e8fce2ff189ee791909f986edaaa96533f9897e9d4d1098f144164fedf5c696cd286fd09c8ad2d28103cfb60098771aa1d69f6a896abe6a57329c.css"
            integrity="sha512-mBtUhwQOj84v8YnueRkJ&#43;YbtqqllM/mJfp1NEJjxRBZP7fXGls0ob9CcitLSgQPPtgCYdxqh1p9qiWq&#43;alcynA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Making a Multiplayer FPS in C&#43;&#43; Part 3: Multiple Players -
            
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Making a Multiplayer FPS in C&#43;&#43; </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part8/" title="./multiplayer-fps/part8/">
                         Part 8: Client-Side Prediction Revisited 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part7/" title="./multiplayer-fps/part7/">
                         Part 7: The Vulkan Projection Matrix 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part6/" title="./multiplayer-fps/part6/">
                         Part 6: Cleanup 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part5/" title="./multiplayer-fps/part5/">
                         Part 5: Client-Side Prediction 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part4/" title="./multiplayer-fps/part4/">
                         Part 4: Rebuilding The Client in C&#43;&#43; 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part3/" title="./multiplayer-fps/part3/">
                         Part 3: Multiple Players 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part2/" title="./multiplayer-fps/part2/">
                         Part 2: The Main Loop 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part1/" title="./multiplayer-fps/part1/">
                         Part 1: Hello Multiplayer World 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/unity-client-side-prediction/" title="./posts/unity-client-side-prediction/">
                         Client-Side Prediction With Physics In Unity 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/ditching-the-mutex/" title="./posts/ditching-the-mutex/">
                         Ditching the Mutex 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>


        
            <div class="headerLogo">
                <a href="https://codersblock.org/"><img src="https://codersblock.org/images/logo.png"/></a>
            </div>
        
        <div class="title">
            <h1 class="title-header">
                Making a Multiplayer FPS in C&#43;&#43; Part 3: Multiple Players
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/joe-best-rotheray/"
                                class="cat-btn">
                                Joe Best-Rotheray
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2016.08.30"
                            >2016.08.30
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        10 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="https://codersblock.org/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/" class="bread-btn">
    

    
        Making a Multiplayer FPS in C&#43;&#43;
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/part3/" class="bread-btn">
    

    
        Part 3: Multiple Players
    
</a>

                </div>
            

            
        </div>

        
            

        


        <div class="content">
            
                <p>In the previous part of this series we ended up with a basic outline of an online game with some very simple game logic, a fixed tick rate, and support for a single connected client. In this part, we&rsquo;ll be adding support for multiple clients. You can see the repository as it was at this stage of development <a href="https://github.com/spectre1989/odin/tree/5fd76d229bef8cbd8c78bf75cb4991a1ad940bdf">here</a>.</p>
<p>The first thing we&rsquo;ll need is to actually keep track of the clients who send the server packets. At the moment we store their IP address and port we get from <code>recvfrom</code>, but now we&rsquo;ll need some kind of list of IP addresses and ports of the clients so they can be sent state packets en masse. For this I created an <code>IP_Endpoint</code> struct:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20IP_Endpoint%0a%7b%0a%20%20%20uint32%20address;%0a%20%20%20uint16%20port;%0a%7d;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">IP_Endpoint</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint16</span> <span class="n">port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Then we need an array of them - the size of which dependent upon game design, for now I&rsquo;m using 32, but I&rsquo;ll store it in a const so it&rsquo;s easily changeable. Now that we&rsquo;re having multiple players, we&rsquo;ll also need their <code>x</code>, <code>y</code>, <code>facing</code>, and <code>speed</code> values which make up their state. I&rsquo;ll group those in a <code>Player_State</code> struct:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Player_State%0a%7b%0a%20%20%20float32%20x,%20y,%20facing,%20speed;%0a%7d;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Player_State</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">float32</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">facing</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Currently our code waits for user input before executing the next tick, but this won&rsquo;t work for multiple users (even on a LAN if we have enough users). Eventually clients will deliver input packets slightly ahead of the tick they are needed for, but for now we&rsquo;ll just store whatever the most recent input was for each player. Then on each tick we blast through all of them, updating each <code>Player_State</code> struct accordingly. So for that reason I created a <code>Player_Input</code> struct:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Player_Input%0a%7b%0a%20%20%20bool32%20up,%20down,%20left,%20right;%0a%7d;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Player_Input</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">bool32</span> <span class="n">up</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>But we have a problem - when a player sends us a packet, how do we know if they&rsquo;ve sent us a packet before? We could search through the array of <code>IP_Endpoint</code>s for their address and port, this would probably be OK for a game with a relatively small number of players on each server, but for something like an MMO it would negatively affect performance.</p>
<p>An easy way to solve this is to assign each player a unique identifier when they join the server, which is actually an index into an array. Any packet sent from the client to the server must include this ID, the server can then check that the address and port that the packet came from, matches those in the <code>IP_Endpoint</code> array (otherwise a player could pretend to be someone else by sending a different ID).</p>
<p>For this, we&rsquo;ll now need to start having multiple packet types. Previously, every packet from the client to the server contained user input, and every packet from the server to the client contained game state. That will no longer be the case, we&rsquo;ll need packets for the following:</p>
<ul>
<li>client joining server (requesting ID)</li>
<li>server telling client their ID</li>
<li>client leaving server (a timeout would do, but this is better)</li>
<li>client sending user input to server</li>
<li>server sending game state to client</li>
</ul>
<p>Every packet will have to start with a number describing the type of packet it is, for now this needs only be one byte as we have less than 256 packet types. I&rsquo;ll use an enum for this, or rather, two enums - one for client messages, and one for server messages:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">Client_Message</span> <span class="o">:</span> <span class="n">uint8</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Join</span><span class="p">,</span>      <span class="c1">// tell server we&#39;re new here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">Leave</span><span class="p">,</span>      <span class="c1">// tell server we&#39;re leaving
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">Input</span>       <span class="c1">// tell server our user input
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">Server_Message</span> <span class="o">:</span> <span class="n">uint8</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Join_Result</span><span class="p">,</span><span class="c1">// tell client they&#39;re accepted/rejected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">State</span>       <span class="c1">// tell client game state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>


    



    

<img src="/images/mpfps_03/img001_hu4996cbd334771e2ecf1c1aab9df52973_409306_1000x0_resize_box_3.png"/>
<sub>Packet structure (top: client -&gt; server, bottom: server -&gt; client)</sub></p>
<p>Having a message telling the server that the client is leaving is a good idea, but what happens if the client crashes? We&rsquo;ll need a simple timeout system. Clients will always be sending a steady stream of input packets, so we&rsquo;ll just have a per-client counter which is incremented every tick, and reset back to zero when an input packet is received. This will tell us how long it&rsquo;s been since we&rsquo;ve heard from that client.</p>
<p>So now, just before entering the main loop on the server, we&rsquo;ll have these arrays:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20IP_Endpoint%20client_endpoints[MAX_CLIENTS];%0a%20%20%20float32%20time_since_heard_from_clients[MAX_CLIENTS];%0a%20%20%20Player_State%20client_objects[MAX_CLIENTS];%0a%20%20%20Player_Input%20client_inputs[MAX_CLIENTS];">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="n">IP_Endpoint</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">MAX_CLIENTS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="n">float32</span> <span class="n">time_since_heard_from_clients</span><span class="p">[</span><span class="n">MAX_CLIENTS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="n">Player_State</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">MAX_CLIENTS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="n">Player_Input</span> <span class="n">client_inputs</span><span class="p">[</span><span class="n">MAX_CLIENTS</span><span class="p">];</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>When we only supported one client, the server would wait for input from the client before carrying on with the tick. Part of the reason for this is that <code>recvfrom</code> is a blocking function, it won&rsquo;t return until a packet is received. We don&rsquo;t want our server to ever wait like this, so we could call <code>recvfrom</code> on a different thread, but an easier method which will do fine for now is to switch the socket to non-blocking mode, like this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="u_long%20enabled%20=%201;%0aioctlsocket%28%20sock,%20FIONBIO,%20&amp;enabled%20%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">u_long</span> <span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ioctlsocket</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Any calls to <code>recvfrom</code> made when there are no packets to consume, will return <code>SOCKET_ERROR</code>, and <code>WSAGetLastError</code> will return <code>WSAEWOULDBLOCK</code>. So now on each tick, we just call <code>recvfrom</code> until it returns <code>SOCKET_ERROR</code>, and then get on with updating the game state and sending it back to the clients:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">SOCKADDR_IN</span> <span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">from_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">from</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">SOCKET_BUFFER_SIZE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_size</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">bytes_received</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">WSAGetLastError</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">error</span> <span class="o">!=</span> <span class="n">WSAEWOULDBLOCK</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">printf</span><span class="p">(</span> <span class="s">&#34;recvfrom returned SOCKET_ERROR, WSAGetLastError() %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">IP_Endpoint</span> <span class="n">from_endpoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">from_endpoint</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">from_endpoint</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">from</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">switch</span><span class="p">(</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">Client_Message</span><span class="o">::</span><span class="nl">Join</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">Client_Message</span><span class="o">::</span><span class="nl">Leave</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">Client_Message</span><span class="o">::</span><span class="nl">Input</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>The case for <code>Client_Message::Join</code> looks like this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">uint16</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">uint16</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">uint16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CLIENTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">slot</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int8</span><span class="p">)</span><span class="n">Server_Message</span><span class="o">::</span><span class="n">Join_Result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">slot</span> <span class="o">!=</span> <span class="n">uint16</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">sendto</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="n">from_size</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">client_endpoints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_endpoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">time_since_heard_from_clients</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">client_objects</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="n">client_inputs</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">sendto</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="n">from_size</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>First we look for an empty slot, this is determined by finding an <code>IP_Endpoint</code> in the array with an address of 0 (these are zero-initialised during startup, and set to 0 when a client leaves or times out). If an available slot is found, then this is used for the client ID. A <code>Join_Result</code> message is sent back to the client, the second byte of the packet indicates whether joining was successful, and if so, the assigned client ID follows. For now I&rsquo;m using a 16-bit unsigned integer - I figure for development purposes we&rsquo;re unlikely to need more than ~65000 client IDs. If the slot was found, we store the <code>IP_Endpoint</code> in the array, and zero-initialise their <code>Player_State</code> and <code>Player_Input</code>.</p>
<p>The case for <code>Client_Message::Leave</code> just zeroes the <code>IP_Endpoint</code> for that client:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="uint16%20slot;%0amemcpy%28%20&amp;slot,%20&amp;buffer[1],%202%20%29;%0a%0aif%28%20client_endpoints[slot]%20==%20from_endpoint%20%29%0a%7b%0a%20%20%20client_endpoints[slot]%20=%20%7b%7d;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">uint16</span> <span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">==</span> <span class="n">from_endpoint</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">client_endpoints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Finally the case for <code>Client_Message::Input</code> grabs the user input (this time in the fourth byte of the packet) and does some bitwise operations to convert back into individual key presses:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="uint16%20slot;%0amemcpy%28%20&amp;slot,%20&amp;buffer[1],%202%20%29;%0a%0aif%28%20client_endpoints[slot]%20==%20from_endpoint%20%29%0a%7b%0a%20%20%20uint8%20input%20=%20buffer[3];%0a%0a%20%20%20client_inputs[slot].up%20=%20input%20&amp;%200x1;%0a%20%20%20client_inputs[slot].down%20=%20input%20&amp;%200x2;%0a%20%20%20client_inputs[slot].left%20=%20input%20&amp;%200x4;%0a%20%20%20client_inputs[slot].right%20=%20input%20&amp;%200x8;%0a%0a%20%20%20time_since_heard_from_clients[slot]%20=%200.0f;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">uint16</span> <span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">==</span> <span class="n">from_endpoint</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint8</span> <span class="n">input</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">client_inputs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">up</span> <span class="o">=</span> <span class="n">input</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">client_inputs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">down</span> <span class="o">=</span> <span class="n">input</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">client_inputs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">left</span> <span class="o">=</span> <span class="n">input</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">client_inputs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">right</span> <span class="o">=</span> <span class="n">input</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">time_since_heard_from_clients</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>Next comes the actual update loop:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="for%28%20uint16%20i%20=%200;%20i%20%3c%20MAX_CLIENTS;%20&#43;&#43;i%20%29%0a%7b%0a%20%20%20if%28%20client_endpoints[i].address%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20if%28%20client_inputs[i].up%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20client_objects[i].speed%20&#43;=%20ACCELERATION%20*%20SECONDS_PER_TICK;%0a%20%20%20%20%20%20%20%20%20if%28%20client_objects[i].speed%20%3e%20MAX_SPEED%20%29%0a%20%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20client_objects[i].speed%20=%20MAX_SPEED;%0a%20%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20if%28%20client_inputs[i].down%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20client_objects[i].speed%20-=%20ACCELERATION%20*%20SECONDS_PER_TICK;%0a%20%20%20%20%20%20%20%20%20if%28%20client_objects[i].speed%20%3c%200.0f%20%29%0a%20%20%20%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20client_objects[i].speed%20=%200.0f;%0a%20%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20if%28%20client_inputs[i].left%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20client_objects[i].facing%20-=%20TURN_SPEED%20*%20SECONDS_PER_TICK;%0a%20%20%20%20%20%20%7d%0a%20%20%20%20%20%20if%28%20client_inputs[i].right%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20client_objects[i].facing%20&#43;=%20TURN_SPEED%20*%20SECONDS_PER_TICK;%0a%20%20%20%20%20%20%7d%0a%0a%20%20%20%20%20%20client_objects[i].x%20&#43;=%20client_objects[i].speed%20*%20SECONDS_PER_TICK%20*%20sinf%28%20client_objects[i].facing%20%29;%0a%20%20%20%20%20%20client_objects[i].y%20&#43;=%20client_objects[i].speed%20*%20SECONDS_PER_TICK%20*%20cosf%28%20client_objects[i].facing%20%29;%0a%0a%20%20%20%20%20%20time_since_heard_from_clients[i]%20&#43;=%20SECONDS_PER_TICK;%0a%20%20%20%20%20%20if%28%20time_since_heard_from_clients[i]%20%3e%20CLIENT_TIMEOUT%20%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20client_endpoints[i]%20=%20%7b%7d;%0a%20%20%20%20%20%20%7d%0a%20%20%20%7d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">uint16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CLIENTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">client_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">up</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">+=</span> <span class="n">ACCELERATION</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">MAX_SPEED</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">client_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">down</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">-=</span> <span class="n">ACCELERATION</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mf">0.0f</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">client_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">left</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="o">-=</span> <span class="n">TURN_SPEED</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">client_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">right</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="o">+=</span> <span class="n">TURN_SPEED</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">+=</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span> <span class="o">*</span> <span class="n">sinf</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="o">+=</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">*</span> <span class="n">SECONDS_PER_TICK</span> <span class="o">*</span> <span class="n">cosf</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">time_since_heard_from_clients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">SECONDS_PER_TICK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">time_since_heard_from_clients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">CLIENT_TIMEOUT</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>We iterate over each <code>IP_Endpoint</code> and for those which are in use, update their <code>Player_State</code> based on their current <code>Player_Input</code>. Clients timing-out is also handled here. There is a minor issue here that we iterate over the entire <code>IP_Endpoint</code> array, including all of those which aren&rsquo;t in use. Not to worry, I will deal with this at a later date.</p>
<p>Then the actual state packet is created. For now, everyone gets sent the same game state packet. It&rsquo;s possible that some games benefit from different players being sent different subsets of the game state, e.g. for anti-cheat reasons, or because the entire game state is huge (tangent - this is why I&rsquo;m always skeptical of off-the-shelf networking systems, different games have different networking requirements):</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int8</span><span class="p">)</span><span class="n">Server_Message</span><span class="o">::</span><span class="n">State</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">int32</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">uint16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CLIENTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">i</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_written</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bytes_written</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">client_objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">facing</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>You might be thinking - why not write this state to the packet during the previous loop? Well, we actually could right now, and it would work fine. The problem is that at some point in the hopefully not-too-distant future, players will start to be able to shoot at each other and so forth. That means that we can&rsquo;t definitely be sure that a player hasn&rsquo;t been destroyed until the end of the tick, so only at that point can we be sure that they should be included in the game state packet.</p>
<p>Finally the state packet is sent to all the clients:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="int%20flags%20=%200;%0aSOCKADDR_IN%20to;%0ato.sin_family%20=%20AF_INET;%0aint%20to_length%20=%20sizeof%28%20to%20%29;%0a%0afor%28%20uint16%20i%20=%200;%20i%20%3c%20MAX_CLIENTS;%20&#43;&#43;i%20%29%0a%7b%0a%20%20%20if%28%20client_endpoints[i].address%20%29%0a%20%20%20%7b%0a%20%20%20%20%20%20to.sin_addr.S_un.S_addr%20=%20client_endpoints[i].address;%0a%20%20%20%20%20%20to.sin_port%20=%20client_endpoints[i].port;%0a%0a%20%20%20%20%20%20sendto%28%20sock,%20buffer,%20bytes_written,%20flags,%20%28SOCKADDR*%29&amp;to,%20to_length%20%29;%0a%20%20%20%7d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SOCKADDR_IN</span> <span class="n">to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">to</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">to_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">to</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">uint16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CLIENTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">to</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">S_un</span><span class="p">.</span><span class="n">S_addr</span> <span class="o">=</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">to</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">client_endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">sendto</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="n">to_length</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>So without too much work, we have a server which supports multiple users.</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            

            
                <li>Joe Best-Rotheray</li>
            

            
                
                    <li>
                        
                            <a href="mailto:joe@codersblock.org" target="_blank">
                                <i class="bi-envelope"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="spectre1989" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="joebestrotheray" target="_blank">
                                <i class="bi-linkedin"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
                    <li>
                        
                            <a href="codersblock" target="_blank">
                                <i class="bi-twitter"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1941
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.121.2</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Aug 30 2016 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
