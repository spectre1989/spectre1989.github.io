<!DOCTYPE html>
<html lang="en-gb">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.121.2">

    

    

    
        
            <meta
                name="description"
                content="Adventures in netcode, game engines, and game development" />
        

        
            <meta
                name="keywords"
                content="netcode,programming,gamedev,c&#43;&#43;,unreal,UE5,unity,games,sockets" />
        

        
            <meta
                name="author"
                content="Joe Best-Rotheray" />
        

    


    <title>
        
            Making a Multiplayer FPS in C&#43;&#43; Part 6: Cleanup |
            
        
    </title>

    

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&display=swap" rel="stylesheet">

    
    

    
    


    
    


    
    


    
    

    


    
    
        
            
            
        
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_b09f3b5.min.c7ef441446476adbc9b032ef2f25288a80245867161335a85691e31d5232d48ae3288a95626e84440ff37eebcf7e43d3ea9895fea7b1c83cf39a7646d49d45c1.css"
            integrity="sha512-x&#43;9EFEZHatvJsDLvLyUoioAkWGcWEzWoVpHjHVIy1IrjKIqVYm6ERA/zfuvPfkPT6piV/qexyDzzmnZG1J1FwQ==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Making a Multiplayer FPS in C&#43;&#43; Part 6: Cleanup -
            
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Making a Multiplayer FPS in C&#43;&#43; </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part8/" title="./multiplayer-fps/part8/">
                         Part 8: Client-Side Prediction Revisited 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part7/" title="./multiplayer-fps/part7/">
                         Part 7: The Vulkan Projection Matrix 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part6/" title="./multiplayer-fps/part6/">
                         Part 6: Cleanup 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part5/" title="./multiplayer-fps/part5/">
                         Part 5: Client-Side Prediction 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part4/" title="./multiplayer-fps/part4/">
                         Part 4: Rebuilding The Client in C&#43;&#43; 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part3/" title="./multiplayer-fps/part3/">
                         Part 3: Multiple Players 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part2/" title="./multiplayer-fps/part2/">
                         Part 2: The Main Loop 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/multiplayer-fps/part1/" title="./multiplayer-fps/part1/">
                         Part 1: Hello Multiplayer World 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/unity-client-side-prediction/" title="./posts/unity-client-side-prediction/">
                         Client-Side Prediction With Physics In Unity 
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://codersblock.org/posts/ditching-the-mutex/" title="./posts/ditching-the-mutex/">
                         Ditching the Mutex 
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>


        
            <div class="headerLogo">
                <a href="https://codersblock.org/"><img src="https://codersblock.org/images/logo.png"/></a>
            </div>
        
        <div class="title">
            <h1 class="title-header">
                Making a Multiplayer FPS in C&#43;&#43; Part 6: Cleanup
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/joe-best-rotheray/"
                                class="cat-btn">
                                Joe Best-Rotheray
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2018.01.11"
                            >2018.01.11
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        8 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="https://codersblock.org/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/" class="bread-btn">
    

    
        Making a Multiplayer FPS in C&#43;&#43;
    
</a>




    /



<a href="https://codersblock.org/multiplayer-fps/part6/" class="bread-btn">
    

    
        Part 6: Cleanup
    
</a>

                </div>
            

            
        </div>

        
            

        


        <div class="content">
            
                <p>In the previous part of this series, we added client-side prediction. At this point the codebase was getting a bit creaky with all the &ldquo;todo&rdquo; comments in the code, so I took a bit of time to address as many of them as possible (browse the code for this part <a href="https://github.com/spectre1989/odin/tree/6d97c43ddfc0c21d99bb6cb63e332ca28de69fe5">here</a>).</p>
<h3 id="a-circular-buffer-utility">A Circular Buffer Utility</h3>
<p>Circular buffers are a great way to avoid dynamic allocation/deallocation, you can usually calculate how many items you&rsquo;d need at maximum and just do a single allocation. There were a few places where I was using one - input buffering on the server, client recording of inputs and predicted results for client-side prediction, and the packet buffers used for faking lag on the client. It would be nice to compress the code common to all three, into some kind of generic utility. The classic template container approach would be something like:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="template%20%3ctypename%20T%3e%0aclass%20Circular_Buffer%0a%7b%0a%20%20%20T*%20m_items;%0a%20%20%20uint32%20m_capacity;%0a%20%20%20uint32%20m_head;%0a%20%20%20uint32%20m_size;%0a%20%20%20%0a%20%20%20void%20push%28const%20T&amp;%20item%29;%0a%20%20%20void%20pop%28T&amp;%20item%29;%0a%7d;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Circular_Buffer</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">T</span><span class="o">*</span> <span class="n">m_items</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">m_capacity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">m_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">m_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kt">void</span> <span class="nf">pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>This has a problem, take for example the client-side prediction circular buffer which stores predicted state for the local player, and the user inputs used for each tick. The state, and input data, are two separate arrays:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="constexpr%20uint32%20c_max_predicted_ticks%20=%20c_prediction_history_capacity%20*%202;%0aPlayer_State%20prediction_history_state[c_prediction_history_capacity];%0aPlayer_Input%20prediction_history_input[c_prediction_history_capacity];%0auint32%20prediction_history_head%20=%200;%0auint32%20prediction_history_tail%20=%200;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">constexpr</span> <span class="n">uint32</span> <span class="n">c_max_predicted_ticks</span> <span class="o">=</span> <span class="n">c_prediction_history_capacity</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Player_State</span> <span class="n">prediction_history_state</span><span class="p">[</span><span class="n">c_prediction_history_capacity</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">Player_Input</span> <span class="n">prediction_history_input</span><span class="p">[</span><span class="n">c_prediction_history_capacity</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">uint32</span> <span class="n">prediction_history_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">uint32</span> <span class="n">prediction_history_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>So to use the template approach we&rsquo;d have to combine state and input into a struct:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Predicted_Data%0a%7b%0a%20%20%20Player_State%20state;%0a%20%20%20Player_Input%20input;%0a%7d;%0aCircular_Buffer%3cPredicted_Data%3e%20m_prediction_history;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Predicted_Data</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Player_State</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">Player_Input</span> <span class="n">input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">Circular_Buffer</span><span class="o">&lt;</span><span class="n">Predicted_Data</span><span class="o">&gt;</span> <span class="n">m_prediction_history</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>This forces us to arrange circular buffer data as an <em><strong>array of structs</strong></em>, rather than <em><strong>struct of arrays</strong></em>. In future when we start worrying about packet loss, the client will include redundant input data in each input packet (i.e. it will send a packet with the input for tick <code>n</code>, along with the input for ticks <code>(n-1)</code>, <code>(n-2)</code>, etc, in case some of those previous packets didn&rsquo;t arrive). With an array of structs, when we iterate back through the player input we&rsquo;d also pull the predicted player state in to the CPU cache even though we don&rsquo;t need to read it.</p>
<p>So to have a <em><strong>struct of arrays</strong></em> we could just have two circular buffer objects - <code>Circular_Buffer&lt;Player_State&gt;</code> and <code>Circular_Buffer&lt;Player_Input&gt;</code>. That&rsquo;s a bit messy, and means any logic done in the <code>Circular_Buffer</code> (e.g. checking if the buffer is full, or empty, calculating the new head index, etc) gets duplicated. It&rsquo;s also possible they could get out of sync if a function is called on one, but accidentally not called on the other.</p>
<p>Another option is some completely bananas template metaprogramming, which is hard to read, possibly bloats compile times, and ultimately still has ugly usage code.</p>
<p>Though really, all the circular buffer needs to do is maintain the tail/write index, and head/read index, there&rsquo;s no actual need to contain the items as well. So what I actually did, was something like this:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Circular_Index%0a%7b%0a%20%20%20uint32%20head;%0a%20%20%20uint32%20size;%0a%20%20%20uint32%20capacity;%0a%7d;%0avoid%20circular_index_create%28Circular_Index*%20index,%20uint32%20capacity%29;%0avoid%20circular_index_push%28Circular_Index*%20index%29;%0avoid%20circular_index_pop%28Circular_Index*%20index%29;%0auint32%20circular_index_tail%28Circular_Index*%20index%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Circular_Index</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span> <span class="n">capacity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">circular_index_create</span><span class="p">(</span><span class="n">Circular_Index</span><span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="n">uint32</span> <span class="n">capacity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">circular_index_push</span><span class="p">(</span><span class="n">Circular_Index</span><span class="o">*</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">circular_index_pop</span><span class="p">(</span><span class="n">Circular_Index</span><span class="o">*</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">uint32</span> <span class="nf">circular_index_tail</span><span class="p">(</span><span class="n">Circular_Index</span><span class="o">*</span> <span class="n">index</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>So the prediction history looks something like:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="constexpr%20uint32%20c_prediction_history_capacity%20=%20c_ticks_per_second%20*%202;%0aPlayer_State*%20prediction_history_state;%0aPlayer_Input*%20prediction_history_input;%0aCircular_Index%20prediction_history_index;%0acircular_index_create%28&amp;prediction_history_index,%20c_prediction_history_capacity%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">constexpr</span> <span class="n">uint32</span> <span class="n">c_prediction_history_capacity</span> <span class="o">=</span> <span class="n">c_ticks_per_second</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Player_State</span><span class="o">*</span> <span class="n">prediction_history_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Player_Input</span><span class="o">*</span> <span class="n">prediction_history_input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Circular_Index</span> <span class="n">prediction_history_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">circular_index_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prediction_history_index</span><span class="p">,</span> <span class="n">c_prediction_history_capacity</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>As a side-note, it occurs to me now that actually in the case of prediction history or input buffering, there&rsquo;s actually no need to pop the old items as they become irrelevant, we <em>could</em> just overwrite the oldest ones. The only case where we <em>do</em> care is the fake lag packet buffering. For example when sending a packet, it is held in a buffer for a bit and then sent, which simulates lag. In the case that this buffer is full, we log a warning, and then send the oldest packet early.</p>
<h3 id="custom-allocators">Custom Allocators</h3>
<p>I had a bunch of big-ish arrays on the stack, and some stuff in the graphics layer allocated with <code>new</code> and <code>delete</code>. Taking control of memory allocation is an opportunity for big performance wins, as well as making it easier to track memory usage and so on. For now I only need two allocators, <em><strong>permanent</strong></em> and <em><strong>temporary</strong></em>. The former is for stuff which will be needed for the entire lifetime of the game, and the latter is just a scratch space.</p>
<p>Both of these are <em><strong>linear allocators</strong></em>, which means we have a pointer to a block of free memory, and whenever an allocation is made we bump the pointer along. The underlying free memory block is allocated once up-front when the game starts - using <code>VirtualAlloc</code> to do this allows us to specify the base address of the allocated memory, this is particularly useful for debugging as (if allocations are deterministic) it can allow for memory breakpoints to work across multiple runs of the game.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Memory_Allocator%0a%7b%0a%20%20%20uint8*%20memory;%0a%20%20%20uint8*%20next;%0a%20%20%20uint64%20bytes_remaining;%0a%7d;%0a%0auint8*%20memory_allocator_alloc%28Memory_Allocator*%20allocator,%20uint64%20size%29%0a%7b%0a%20%20%20assert%28allocator-%3ebytes_remaining%20%3e=%20size%29;%0a%20%20%20uint8*%20mem%20=%20allocator-%3enext;%0a%20%20%20allocator-%3enext%20&#43;=%20size;%0a%20%20%20return%20mem;%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Memory_Allocator</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint8</span><span class="o">*</span> <span class="n">memory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint8</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint64</span> <span class="n">bytes_remaining</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">uint8</span><span class="o">*</span> <span class="nf">memory_allocator_alloc</span><span class="p">(</span><span class="n">Memory_Allocator</span><span class="o">*</span> <span class="n">allocator</span><span class="p">,</span> <span class="n">uint64</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">assert</span><span class="p">(</span><span class="n">allocator</span><span class="o">-&gt;</span><span class="n">bytes_remaining</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint8</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">allocator</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<p>This doesn&rsquo;t mean we can never free anything, but it means we have to free memory in the reverse-order that it was allocated, or (as we&rsquo;ll likely do with the temporary allocator) free the entire thing. In future we&rsquo;ll probably want different allocators for different systems (e.g. graphics, gameplay, etc) but I try not to do things until they&rsquo;re actually needed.</p>
<p>It&rsquo;s important to mention that I&rsquo;m not yet worrying about the alignment of allocated memory. It&rsquo;s generally good practice to naturally align data (meaning that for example a 4-byte integer is stored on a 4-byte boundary). Some platforms, like arm, will actually crash if you don&rsquo;t. On the other hand, x86 will do it, but it will incur a performance penalty. This penalty is supposedly dwindling with modern processors, so I&rsquo;m planning to wait until there&rsquo;s a fair amount of game going on, and then turn on alignment and see how much difference it actually makes.</p>
<p>There are tons of different ways to implement an allocator, I try to use the simplest that will do what I need - simpler often means faster. One of the trickiest to implement is a general-purpose allocator (a replacement for <code>malloc</code>/<code>free</code>), but if possible I want to avoid <em>ever</em> using one. A <code>malloc</code> style allocator would have no knowledge about the lifetime of memory being requested, or the relationships between allocations. We can take advantage of our knowledge of this stuff to carefully choose where and how allocations happen, improve performance, and reduce memory fragmentation. There may be a case where we <em>really</em> need one, but I have yet to encounter one.</p>
<h3 id="globals">Globals</h3>
<p>At some point you&rsquo;re (probably?) going to need some globals. You can use a singleton and <em>pretend</em> you don&rsquo;t have any globals, but they&rsquo;re still globals. I like to put mine in a struct so at least they&rsquo;re in one place, and it&rsquo;s easier to see at a glance if they&rsquo;re getting out of hand.</p>
<p>The aforementioned permanent and temporary memory allocators live in there, along with some stuff to do with timing. Lastly there&rsquo;s a function pointer to a logging function, this was something I needed because the server (being a console application) needs to send logging to stdout, whereas the client sends logging to <code>OutputDebugStringA</code> (the Visual Studio debug output window). Code used by both the server and client (e.g the socket code) doesn&rsquo;t need to figure out which to call, the function pointer takes care of it.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="struct%20Globals%0a%7b%0a%20%20%20Memory_Allocator%20permanent_allocator;%0a%20%20%20Memory_Allocator%20temp_allocator;%0a%20%20%20Log_Function*%20log_function;%0a%20%20%20LARGE_INTEGER%20clock_frequency;%0a%20%20%20bool32%20sleep_granularity_was_set;%0a%7d;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Globals</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Memory_Allocator</span> <span class="n">permanent_allocator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">Memory_Allocator</span> <span class="n">temp_allocator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">Log_Function</span><span class="o">*</span> <span class="n">log_function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">LARGE_INTEGER</span> <span class="n">clock_frequency</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">bool32</span> <span class="n">sleep_granularity_was_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div>
    
</div>
<h3 id="socket-buffers">Socket Buffers</h3>
<p>When packets are sent via a socket, it initially will be placed in an internal buffer which is managed by the underlying implementation. Received packets are also placed into a buffer. It&rsquo;s possible to find out how big these are with <code>getsockopt</code>, in my case the default is 64KiB. So if we assume the server is sending 1KiB to each connected client per tick, that means potentially being limited to a maximum of 64 players (actually less, because packet headers take up a bit of space).</p>
<p>I&rsquo;ve upped these buffers to be 1MiB which I expect will be sufficient, but it&rsquo;s difficult to know at this early stage. Socket errors are logged, so if the buffers are exceeded then we&rsquo;ll be able to see. It isn&rsquo;t the end of the world if that does happen on occasion - to the game this will look the same as a burst of packet loss.</p>
<h3 id="non-unity-builds">Non-Unity Builds</h3>
<p>Although I like to use Unity builds (bundling multiple cpp files into a single translation unit), plenty of people don&rsquo;t. So it&rsquo;d probably be a good idea if it was possible to compile the project as individual cpp files too. I probably won&rsquo;t remember to do this all the time, but I&rsquo;ll check and fix issues periodically.</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            

            
                <li>Joe Best-Rotheray</li>
            

            
                
                    <li>
                        
                            <a href="mailto:joe@codersblock.org" target="_blank">
                                <i class="bi-envelope"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="spectre1989" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
                    <li>
                        
                            <a href="joebestrotheray" target="_blank">
                                <i class="bi-linkedin"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
                    <li>
                        
                            <a href="codersblock" target="_blank">
                                <i class="bi-twitter"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1512
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.121.2</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Jan 11 2018 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
